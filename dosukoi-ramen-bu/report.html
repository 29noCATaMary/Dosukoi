<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ¦æœã‚’å ±å‘Šã™ã‚‹ | ã©ã™ã“ã„ãƒ©ãƒ¼ãƒ¡ãƒ³éƒ¨</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Rampart+One&family=Reggae+One&family=Zen+Kaku+Gothic+New:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .report-form {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            margin: 2rem auto;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: var(--color-secondary);
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-family: inherit;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--color-primary);
            outline: none;
        }

        .preview-image {
            width: 100%;
            height: 200px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 0.5rem;
            border-radius: 5px;
            overflow: hidden;
        }

        .preview-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="logo">ã©ã™ã“ã„æˆ¦æœå ±å‘Š</div>
        <nav class="nav">
            <ul>
                <li><a href="index.html">â† æˆ»ã‚‹</a></li>
            </ul>
        </nav>
    </header>

    <main class="container section">
        <h2 style="text-align: center;">æœ¬æ—¥ã®æˆ¦æœï¼ˆå ±å‘Šï¼‰</h2>
        <form class="report-form">
            <div class="form-group">
                <label>åº—å</label>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="shop-name" placeholder="ä¾‹ï¼šéººå±‹ æ­¦è”µ" required>
                    <button type="button" onclick="searchByAddress()" class="cta-button"
                        style="padding: 0.5rem 1rem; font-size: 0.8rem; width: auto; white-space: nowrap; animation: none;">å ´æ‰€æ¤œç´¢</button>
                </div>
                <div id="gps-suggest"
                    style="font-size: 0.8rem; color: #1a73e8; margin-top: 5px; cursor: pointer; display: none;"></div>
            </div>

            <div class="form-group">
                <label>ãƒ©ãƒ¼ãƒ¡ãƒ³å†™çœŸï¼ˆå¿…é ˆï¼‰<br><small
                        style="font-weight: normal; color: #666;">â€»å†™çœŸã¯ç¾åœ¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã§ã™ã€‚å°†æ¥çš„ã«ä¿å­˜å¯¾å¿œäºˆå®šã€‚</small></label>
                <input type="file" id="ramen-photo" accept="image/*" required>
                <div id="gps-status" style="font-size: 0.8rem; color: #d32f2f; margin-top: 5px;"></div>
                <div class="preview-image"><img id="preview-img" src="" style="display:none;"><span>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span></div>
            </div>

            <div class="form-group">
                <label>å¤–è¦³ãƒ»å†…è¦³å†™çœŸï¼ˆä»»æ„ï¼‰</label>
                <input type="file" accept="image/*">
            </div>

            <!-- Hidden Coordinates -->
            <input type="hidden" id="lat">
            <input type="hidden" id="lng">
            <div id="coordinate-info" style="font-size: 0.8rem; color: #666; margin-bottom: 1rem;"></div>

            <div class="form-group">
                <label>ãƒ©ãƒ¼ãƒ¡ãƒ³ã®ã‚¸ãƒ£ãƒ³ãƒ«</label>
                <select id="shop-type-select">
                    <option>é†¤æ²¹</option>
                    <option>å¡©</option>
                    <option>å‘³å™Œ</option>
                    <option>è±šéª¨</option>
                    <option>å®¶ç³»</option>
                    <option>äºŒéƒç³»</option>
                    <option>éäºŒéƒ</option>
                    <option>é¶ç™½æ¹¯</option>
                    <option>ãã®ä»–ï¼ˆè£ã©ã™ã“ã„ï¼‰</option>
                </select>
            </div>

            <div class="form-group">
                <label>éººã®å¤ªã•</label>
                <select id="noodle-type-select">
                    <option>ç´°éºº</option>
                    <option>ä¸­å¤ª</option>
                    <option>å¤ªéºº</option>
                    <option>æ¥µç´°</option>
                    <option>æ¥µå¤ª</option>
                    <option>ã¡ã¢ã‚Œ</option>
                </select>
            </div>

            <div class="form-group">
                <label>å‘³ã®å‚¾å‘</label>
                <select id="taste-tendency-select">
                    <option>ã‚ã£ã•ã‚Š</option>
                    <option>ã“ã£ã¦ã‚Š</option>
                    <option>æ™®é€š</option>
                </select>
            </div>

            <div class="form-group">
                <label>æº€è¶³åº¦ï¼ˆâ˜…1ã€œ5ï¼‰</label>
                <input type="range" id="rating-range" min="1" max="5" value="3" oninput="updateStars(this.value)">
                <div id="star-display" style="font-size: 1.5rem; color: #f1c40f; margin-top: 5px;">â˜…â˜…â˜…â˜†â˜†</div>
            </div>

            <div class="form-group">
                <label>ç·è©•ï¼ˆè‡ªç”±è¨˜è¿°ï¼‰</label>
                <textarea id="review-text" rows="5" placeholder="ç†±ã„æƒ³ã„ã‚’æ›¸ããªãã‚Œ"></textarea>
            </div>

            <button type="submit" class="cta-button submit-btn" style="width: 100%;">å ±å‘Šå—é ˜ï¼ã©ã™ã“ã„ï¼</button>
        </form>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        (function () {
            "use strict";
            // Initialization wrapper
            try {
                const SUPABASE_URL = 'https://gjvxavvhfdgnnudpqqfa.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdqdnhhdnZoZmRnbm51ZHBxcWZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NTIyNjgsImV4cCI6MjA4NjIyODI2OH0.WcVi6fT5q0gojOt4ZEOKzMm6xaO4qrvXvb7LtCZCN_8';

                if (!window.supabase) {
                    throw new Error("Supabase SDKãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚é€šä¿¡çŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                }
                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                // Elements
                const photoInput = document.getElementById('ramen-photo');
                const previewImg = document.getElementById('preview-img');
                const gpsStatus = document.getElementById('gps-status');
                const gpsSuggest = document.getElementById('gps-suggest');
                const latInput = document.getElementById('lat');
                const lngInput = document.getElementById('lng');
                const coordInfo = document.getElementById('coordinate-info');
                const shopNameInput = document.getElementById('shop-name');
                const starDisplay = document.getElementById('star-display');
                const form = document.querySelector('.report-form');
                const submitBtn = document.querySelector('.submit-btn');

                if (!form) throw new Error("ãƒ•ã‚©ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");

                // Star update helper
                window.updateStars = function (val) {
                    const sd = document.getElementById('star-display');
                    if (!sd) return;
                    let stars = "";
                    for (let i = 1; i <= 5; i++) {
                        stars += (i <= val) ? "â˜…" : "â˜†";
                    }
                    sd.textContent = stars;
                };

                // GPS Extraction
                if (photoInput) {
                    photoInput.onchange = function (e) {
                        const file = e.target.files[0];
                        if (!file) return;

                        const reader = new FileReader();
                        reader.onload = (re) => {
                            if (previewImg) {
                                previewImg.src = re.target.result;
                                previewImg.style.display = 'block';
                                if (previewImg.nextElementSibling && previewImg.nextElementSibling.tagName === 'SPAN') {
                                    previewImg.nextElementSibling.style.display = 'none';
                                }
                            }
                        };
                        reader.readAsDataURL(file);

                        if (window.EXIF) {
                            EXIF.getData(file, function () {
                                const lat = EXIF.getTag(this, "GPSLatitude");
                                const lng = EXIF.getTag(this, "GPSLongitude");
                                const latRef = EXIF.getTag(this, "GPSLatitudeRef") || "N";
                                const lngRef = EXIF.getTag(this, "GPSLongitudeRef") || "E";

                                if (lat && lng) {
                                    const latitude = convertToDegree(lat, latRef);
                                    const longitude = convertToDegree(lng, lngRef);
                                    if (latInput) latInput.value = latitude;
                                    if (lngInput) lngInput.value = longitude;
                                    if (gpsStatus) gpsStatus.textContent = "âœ“ å†™çœŸã‹ã‚‰ä½ç½®æƒ…å ±ã‚’ç‰¹å®šã—ã¾ã—ãŸï¼";
                                    if (coordInfo) coordInfo.textContent = `ç·¯åº¦: ${latitude.toFixed(6)}, çµŒåº¦: ${longitude.toFixed(6)}`;
                                    reverseGeocode(latitude, longitude);
                                } else {
                                    if (gpsStatus) gpsStatus.textContent = "âš  å†™çœŸã«ä½ç½®æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
                                    if (gpsSuggest) gpsSuggest.style.display = 'none';
                                }
                            });
                        }
                    };
                }

                function convertToDegree(gpsArr, ref) {
                    let d = gpsArr[0].numerator / gpsArr[0].denominator;
                    let m = gpsArr[1].numerator / gpsArr[1].denominator;
                    let s = gpsArr[2].numerator / gpsArr[2].denominator;
                    let deg = d + (m / 60) + (s / 3600);
                    return (ref === "S" || ref === "W") ? deg * -1 : deg;
                }

                async function reverseGeocode(lat, lng) {
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
                        const data = await res.json();
                        if (data && data.display_name && gpsSuggest) {
                            const name = data.address.amenity || data.address.shop || data.address.building || "ä»˜è¿‘ã®åº—";
                            gpsSuggest.textContent = `ğŸ’¡ ä»˜è¿‘ã®åº—å€™è£œ: ${name} (ã‚¯ãƒªãƒƒã‚¯ã§å…¥åŠ›)`;
                            gpsSuggest.style.display = 'block';
                            gpsSuggest.onclick = () => {
                                if (shopNameInput) shopNameInput.value = name;
                            };
                        }
                    } catch (err) {
                        console.warn("Reverse geocode failed:", err);
                    }
                }

                window.searchByAddress = async function () {
                    const query = shopNameInput ? shopNameInput.value : "";
                    if (!query) return alert("åº—åã‚’å…¥åŠ›ã—ã¦ãã‚Œï¼");

                    if (gpsStatus) gpsStatus.textContent = "åº—èˆ—ä½ç½®ã‚’æ¤œç´¢ä¸­...";
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
                        const data = await res.json();
                        if (data && data.length > 0) {
                            const latitude = parseFloat(data[0].lat);
                            const longitude = parseFloat(data[0].lon);
                            if (latInput) latInput.value = latitude;
                            if (lngInput) lngInput.value = longitude;
                            if (gpsStatus) gpsStatus.textContent = "âœ“ ä½æ‰€ã‹ã‚‰ä½ç½®ã‚’ç‰¹å®šã—ã¾ã—ãŸï¼";
                            if (coordInfo) coordInfo.textContent = `ç·¯åº¦: ${latitude.toFixed(6)}, çµŒåº¦: ${longitude.toFixed(6)}`;
                        } else {
                            alert("ä½ç½®ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã€‚åˆ¥ã®åå‰ã§è©¦ã—ã¦ãã‚Œã€‚");
                            if (gpsStatus) gpsStatus.textContent = "";
                        }
                    } catch (err) {
                        alert("æ¤œç´¢ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã€‚");
                        console.error(err);
                    }
                };

                // Image Compression Helper
                async function compressImage(file, maxSide = 1600, quality = 0.8) {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = (event) => {
                            const img = new Image();
                            img.src = event.target.result;
                            img.onload = () => {
                                const canvas = document.createElement("canvas");
                                let width = img.width;
                                let height = img.height;

                                if (width > height) {
                                    if (width > maxSide) {
                                        height *= maxSide / width;
                                        width = maxSide;
                                    }
                                } else {
                                    if (height > maxSide) {
                                        width *= maxSide / height;
                                        height = maxSide;
                                    }
                                }

                                canvas.width = width;
                                canvas.height = height;
                                const ctx = canvas.getContext("2d");
                                ctx.drawImage(img, 0, 0, width, height);

                                canvas.toBlob((blob) => {
                                    resolve(blob);
                                }, "image/jpeg", quality);
                            };
                        };
                    });
                }

                // Edit Mode Check
                const urlParams = new URLSearchParams(window.location.search);
                const editId = urlParams.get('id');
                let existingPhotoUrl = null;

                if (editId) {
                    document.querySelector('.logo').textContent = "æˆ¦æœã®å†…å®¹ã‚’ä¿®æ­£";
                    document.querySelector('h2').textContent = "æˆ¦æœã®ä¿®æ­£";
                    const submitBtnText = document.querySelector('.submit-btn');
                    if (submitBtnText) submitBtnText.textContent = "ä¿®æ­£ã‚’ä¿å­˜ï¼ã©ã™ã“ã„ï¼";

                    // Photo becomes optional in edit mode
                    photoInput.required = false;
                    const photoLabel = photoInput.previousElementSibling;
                    if (photoLabel) photoLabel.innerHTML = 'ãƒ©ãƒ¼ãƒ¡ãƒ³å†™çœŸï¼ˆå¤‰æ›´ã™ã‚‹å ´åˆã®ã¿é¸æŠï¼‰<br><small style="font-weight: normal; color: #666;">â€»å†™çœŸã¯ç¾åœ¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã§ã™ã€‚å°†æ¥çš„ã«ä¿å­˜å¯¾å¿œäºˆå®šã€‚</small>';

                    loadExistingReport(editId);
                }

                async function loadExistingReport(id) {
                    try {
                        const { data: rep, error } = await supabase
                            .from('reports')
                            .select('*')
                            .eq('id', id)
                            .single();

                        if (error) throw error;

                        // Security check: must be owner
                        const { data: { session } } = await supabase.auth.getSession();
                        if (!session || rep.user_id !== session.user.id) {
                            alert("ä»–äººã®æˆ¦æœã‚’ä¿®æ­£ã™ã‚‹ã“ã¨ã¯ã§ãã¬ï¼");
                            window.location.href = 'index.html';
                            return;
                        }

                        // Fill Form
                        shopNameInput.value = rep.shop_name || "";
                        document.getElementById('shop-type-select').value = rep.shop_type || "é†¤æ²¹";
                        document.getElementById('noodle-type-select').value = rep.noodle_type || "ä¸­å¤ª";
                        document.getElementById('taste-tendency-select').value = rep.taste_tendency || "æ™®é€š";
                        document.getElementById('rating-range').value = rep.rating || 3;
                        updateStars(rep.rating || 3);
                        document.getElementById('review-text').value = rep.review || "";
                        latInput.value = rep.lat || "";
                        lngInput.value = rep.lng || "";

                        if (rep.photo_url) {
                            existingPhotoUrl = rep.photo_url;
                            previewImg.src = rep.photo_url;
                            previewImg.style.display = 'block';
                            if (previewImg.nextElementSibling && previewImg.nextElementSibling.tagName === 'SPAN') {
                                previewImg.nextElementSibling.style.display = 'none';
                            }
                        }
                    } catch (err) {
                        console.error("Load failed:", err);
                        alert("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                    }
                }

                form.onsubmit = async function (e) {
                    // STOP default behavior immediately
                    if (e) {
                        e.preventDefault();
                        e.stopPropagation();
                    }

                    try {
                        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                        if (sessionError) throw sessionError;
                        if (!session) {
                            alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‹ã‚‰å ±å‘Šã›ã‚ˆï¼");
                            return false;
                        }

                        // Disable button and show progress
                        if (submitBtn) {
                            submitBtn.disabled = true;
                            submitBtn.textContent = "æº–å‚™ä¸­...";
                        }

                        // 1. Image Upload (only if new file selected)
                        let photoUrl = existingPhotoUrl;
                        const file = photoInput.files[0];
                        if (file) {
                            // Validation: Size (10MB)
                            const MAX_SIZE = 10 * 1024 * 1024;
                            if (file.size > MAX_SIZE) {
                                alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ã€‚10MBä»¥ä¸‹ã®ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
                                if (submitBtn) {
                                    submitBtn.disabled = false;
                                    submitBtn.textContent = "å†è©¦è¡Œã™ã‚‹ï¼ˆã©ã™ã“ã„ï¼ï¼‰";
                                }
                                return false;
                            }

                            // Validation: File Type
                            const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/webp'];
                            if (!ALLOWED_TYPES.includes(file.type)) {
                                alert("è¨±å¯ã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚JPG, PNG, WebPå½¢å¼ã®ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
                                if (submitBtn) {
                                    submitBtn.disabled = false;
                                    submitBtn.textContent = "å†è©¦è¡Œã™ã‚‹ï¼ˆã©ã™ã“ã„ï¼ï¼‰";
                                }
                                return false;
                            }

                            try {
                                submitBtn.textContent = "ç”»åƒã‚’åœ§ç¸®ä¸­...";
                                const compressedBlob = await compressImage(file);

                                submitBtn.textContent = "ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...";
                                const fileExt = "jpg"; // Compressed as JPEG
                                const fileName = `${Date.now()}_${Math.random().toString(36).substring(2, 7)}.${fileExt}`;
                                const filePath = `reports/${session.user.id}/${fileName}`;

                                const { data: uploadData, error: uploadError } = await supabase.storage
                                    .from('report-photos')
                                    .upload(filePath, compressedBlob, {
                                        contentType: 'image/jpeg',
                                        cacheControl: '3600',
                                        upsert: false
                                    });

                                if (uploadError) throw uploadError;

                                const { data: { publicUrl } } = supabase.storage
                                    .from('report-photos')
                                    .getPublicUrl(filePath);

                                photoUrl = publicUrl;
                                console.log("Upload success:", photoUrl);
                            } catch (uploadErr) {
                                console.error("Upload error:", uploadErr);
                                alert("ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n" + uploadErr.message);
                                if (submitBtn) {
                                    submitBtn.disabled = false;
                                    submitBtn.textContent = "å†è©¦è¡Œã™ã‚‹ï¼ˆã©ã™ã“ã„ï¼ï¼‰";
                                }
                                return false;
                            }
                        }

                        if (submitBtn) submitBtn.textContent = "ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ä¸­...";

                        const payload = {
                            user_id: session.user.id,
                            shop_name: shopNameInput.value,
                            shop_type: document.getElementById('shop-type-select').value,
                            noodle_type: document.getElementById('noodle-type-select').value,
                            taste_tendency: document.getElementById('taste-tendency-select').value,
                            rating: parseInt(document.getElementById('rating-range').value),
                            review: document.getElementById('review-text').value,
                            lat: latInput.value ? parseFloat(latInput.value) : null,
                            lng: lngInput.value ? parseFloat(lngInput.value) : null,
                            photo_url: photoUrl
                        };

                        console.log("Submitting payload:", payload);

                        let result;
                        if (editId) {
                            result = await supabase.from('reports').update(payload).eq('id', editId);
                        } else {
                            result = await supabase.from('reports').insert([payload]);
                        }

                        console.log("Supabase response:", result);

                        if (result.error) {
                            alert("ã€ä¿å­˜å¤±æ•—ã€‘ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ã¾ã—ãŸ:\n" + JSON.stringify(result.error, null, 2));
                            if (submitBtn) {
                                submitBtn.disabled = false;
                                submitBtn.textContent = editId ? "ä¿®æ­£ã‚’ä¿å­˜ï¼ã©ã™ã“ã„ï¼" : "å ±å‘Šå—é ˜ï¼ã©ã™ã“ã„ï¼";
                            }
                        } else {
                            alert(editId ? "ä¿®æ­£å®Œäº†ï¼ã©ã™ã“ã„ï¼" : "å ±å‘Šå—é ˜ï¼ã©ã™ã“ã„ï¼");
                            window.location.href = 'index.html';
                        }
                    } catch (err) {
                        console.error("Submission error:", err);
                        alert("é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n" + err.message);
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = "å†è©¦è¡Œã™ã‚‹ï¼ˆã©ã™ã“ã„ï¼ï¼‰";
                        }
                    }
                    return false;
                };
            } catch (initErr) {
                console.error("Initialization Failed:", initErr);
                alert("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦è©¦ã—ã¦ãã ã•ã„ã€‚\n" + initErr.message);
            }
        })();
    </script>
</body>

</html>